name: vpn

topology:
  nodes:
    router1:
      kind: linux
      image: frrouting/frr:v7.5.1-lab4
      binds:
        - common/daemons:/etc/frr/daemons
        - common/vtysh.conf:/etc/frr/vtysh.conf
        - router1/frr.conf:/etc/frr/frr.conf
        - router1/interfaces:/etc/network/interfaces
        - router1/swanctl.conf:/etc/swanctl/swanctl.conf
      exec:
        - rc-service networking start
        - rc-service strongswan start
    router2:
      kind: linux
      image: frrouting/frr:v7.5.1-lab4
      binds:
        - common/daemons:/etc/frr/daemons
        - common/vtysh.conf:/etc/frr/vtysh.conf
        - router2/frr.conf:/etc/frr/frr.conf
        - router2/interfaces:/etc/network/interfaces
      exec:
        - rc-service networking start
    router3:
      kind: linux
      image: frrouting/frr:v7.5.1-lab4
      binds:
        - common/daemons:/etc/frr/daemons
        - common/vtysh.conf:/etc/frr/vtysh.conf
        - router3/frr.conf:/etc/frr/frr.conf
        - router3/interfaces:/etc/network/interfaces
        - router3/swanctl.conf:/etc/swanctl/swanctl.conf
      exec:
        - rc-service networking start
        - rc-service strongswan start
    public-network:
      kind: linux
      image: frrouting/frr:v7.5.1
      binds:
        - common/daemons:/etc/frr/daemons
        - common/vtysh.conf:/etc/frr/vtysh.conf
        - public-network/frr.conf:/etc/frr/frr.conf
    srv1:
      kind: linux
      image: alpine:latest
      exec:
        - ip addr add 192.168.1.1/24 dev eth2
        - ip link set eth2 up
        - ip route add 192.168.0.0/16 via 192.168.1.254 dev eth2
    host1:
      kind: linux
      image: alpine:latest
      exec:
        - ip addr add 192.168.2.1/24 dev eth2
        - ip link set eth2 up
        - ip route add 192.168.0.0/16 via 192.168.2.254 dev eth2
    host2:
      kind: linux
      image: alpine:latest
      exec:
        - ip addr add 192.168.3.1/24 dev eth2
        - ip link set eth2 up
        - ip route add 192.168.0.0/16 via 192.168.3.254 dev eth2
  links:
    - endpoints: ["public-network:eth1","router1:eth1"]
    - endpoints: ["public-network:eth2","router2:eth1"]
    - endpoints: ["public-network:eth3","router3:eth1"]
    - endpoints: ["router1:eth2","srv1:eth2"]
    - endpoints: ["router2:eth2","host1:eth2"]
    - endpoints: ["router3:eth2","host2:eth2"]
